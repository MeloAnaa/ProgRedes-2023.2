
import socket
import time
import json
import requests

API_TOKEN = "YOUR_API_TOKEN_HERE"

# Define o endereço e a porta do bot
HOST = "localhost"
PORT = 8080

server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind((HOST, PORT))
server.listen(1)

def send_message(chat_id, text):
    # Monta o payload da mensagem
    payload = json.dumps({
        "chat_id": chat_id,
        "text": text
    })

    requests.post("https://api.telegram.org/bot{}/sendMessage".format(API_TOKEN), data=payload)

# Função para tratar as mensagens do usuário
def handle_message(message):
    # Extrai o ID do chat
    chat_id = message["chat"]["id"]
    text = message["text"]

    # Trata as mensagens de acordo com o comando
    try:
        if text == "/start":
            send_message(chat_id, "Olá! Seja bem-vindo ao meu bot de monitoramento de rede.")
        elif text == "/info":
            send_message(chat_id, "IP: {}".format(socket.gethostbyname("localhost")))
            send_message(chat_id, "Máscara: {}".format(socket.getnetmask(socket.gethostbyname("localhost"))))
            send_message(chat_id, "Gateway: {}".format(socket.getdefaultgateway()))
        elif text == "/ping":
            send_message(chat_id, "Tempo médio de ping: {}ms".format(time.timeit("ping -c 4 localhost", setup="import socket", number=1) * 1000))
        elif text == "/active ip":
            socket.create_connection((text, 80))
            send_message(chat_id, "O IP {} está respondendo".format(text))
        elif text.startswith("/service"):
            ip, port = text.split(" ")[1].split(":")
            socket.create_connection((ip, int(port)))
            send_message(chat_id, "Há um serviço escutando na porta {} do IP {}".format(port, ip))
        elif text == "/dns":
            send_message(chat_id, "Servidor de DNS: {}".format(socket.getfqdn("localhost")))
        elif text == "/map":
            for ip in socket.gethostbyname_ex("localhost")[2]:
                if ip != socket.gethostbyname("localhost"):
                    try:
                        socket.create_connection((ip, 80))
                        send_message(chat_id, "{}:80".format(ip))
                    except:
                        pass
        else:
            send_message(chat_id, "Comando inválido.")
    except (ConnectionError, TimeoutError):
        send_message(chat_id, "Erro ao conectar ao IP ou porta especificado.")
    except Exception:
        send_message(chat_id, "Erro inesperado.")

# Loop principal
while True:
    connection, address = server.accept()
    message = b""
    while True:
        data = connection.recv(1024)
        if not data:
            break
        message += data

    handle_message(json.loads(message.decode()))
    connection.close()


